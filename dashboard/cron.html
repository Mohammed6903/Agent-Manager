<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>OpenClaw Cron Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet" />
    <style>
        :root {
            --bg-primary: #0a0e1a;
            --bg-secondary: #111827;
            --bg-card: rgba(17, 24, 39, 0.7);
            --bg-card-hover: rgba(17, 24, 39, 0.9);
            --border: rgba(255, 255, 255, 0.06);
            --border-glow: rgba(251, 191, 36, 0.3);
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --accent-indigo: #818cf8;
            --accent-blue: #60a5fa;
            --accent-emerald: #34d399;
            --accent-amber: #fbbf24;
            --accent-rose: #fb7185;
            --accent-violet: #a78bfa;
            --accent-cyan: #22d3ee;
            --shadow-lg: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            --shadow-glow: 0 0 40px rgba(251, 191, 36, 0.12);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* BG gradient */
        .bg-gradient {
            position: fixed;
            inset: 0;
            z-index: 0;
            overflow: hidden;
        }

        .bg-gradient::before,
        .bg-gradient::after {
            content: '';
            position: absolute;
            border-radius: 50%;
            filter: blur(120px);
            opacity: 0.12;
            animation: float 20s ease-in-out infinite;
        }

        .bg-gradient::before {
            width: 500px;
            height: 500px;
            background: linear-gradient(135deg, #f6d365, #fda085);
            top: -80px;
            left: -80px;
        }

        .bg-gradient::after {
            width: 400px;
            height: 400px;
            background: linear-gradient(135deg, #a18cd1, #fbc2eb);
            bottom: -80px;
            right: -80px;
            animation-delay: -10s;
        }

        @keyframes float {

            0%,
            100% {
                transform: translate(0, 0) scale(1)
            }

            33% {
                transform: translate(50px, -50px) scale(1.1)
            }

            66% {
                transform: translate(-30px, 30px) scale(.95)
            }
        }

        .app {
            position: relative;
            z-index: 1;
        }

        /* Header */
        .header {
            padding: 16px 32px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid var(--border);
            backdrop-filter: blur(20px);
            background: rgba(10, 14, 26, 0.6);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo {
            width: 34px;
            height: 34px;
            background: linear-gradient(135deg, #f6d365, #fda085);
            border-radius: 9px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 17px;
            font-weight: 800;
        }

        .header h1 {
            font-size: 17px;
            font-weight: 700;
            letter-spacing: -0.5px;
        }

        .header h1 span {
            color: var(--accent-amber);
        }

        .ws-status {
            display: flex;
            align-items: center;
            gap: 7px;
            font-size: 11px;
            font-weight: 500;
            color: var(--text-secondary);
            padding: 5px 12px;
            border-radius: 100px;
            background: rgba(255, 255, 255, .04);
            border: 1px solid var(--border);
        }

        .ws-dot {
            width: 7px;
            height: 7px;
            border-radius: 50%;
            background: var(--accent-rose);
            transition: background .3s;
        }

        .ws-dot.connected {
            background: var(--accent-emerald);
            box-shadow: 0 0 8px var(--accent-emerald);
        }

        /* Toolbar */
        .toolbar {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 32px;
            flex-wrap: wrap;
            background: rgba(255, 255, 255, .02);
            border-bottom: 1px solid var(--border);
        }

        .toolbar label {
            font-size: 10px;
            color: var(--text-muted);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: .5px;
        }

        .toolbar input,
        .toolbar select {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 7px;
            padding: 5px 9px;
            font-size: 12px;
            color: var(--text-primary);
            font-family: inherit;
            outline: none;
        }

        .toolbar input:focus,
        .toolbar select:focus {
            border-color: var(--accent-amber);
        }

        .toolbar select {
            cursor: pointer;
        }

        .toolbar .sep {
            width: 1px;
            height: 24px;
            background: var(--border);
            margin: 0 4px;
            flex-shrink: 0;
        }

        .btn {
            padding: 5px 12px;
            border-radius: 7px;
            border: 1px solid var(--accent-amber);
            background: rgba(251, 191, 36, .1);
            color: var(--accent-amber);
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: all .2s;
            font-family: inherit;
            white-space: nowrap;
        }

        .btn:hover {
            background: rgba(251, 191, 36, .2);
        }

        .btn-danger {
            border-color: var(--accent-rose);
            background: rgba(251, 113, 133, .1);
            color: var(--accent-rose);
        }

        .btn-danger:hover {
            background: rgba(251, 113, 133, .2);
        }

        .btn-success {
            border-color: var(--accent-emerald);
            background: rgba(52, 211, 153, .1);
            color: var(--accent-emerald);
        }

        .btn-success:hover {
            background: rgba(52, 211, 153, .2);
        }

        .btn-blue {
            border-color: var(--accent-blue);
            background: rgba(96, 165, 250, .1);
            color: var(--accent-blue);
        }

        .btn-blue:hover {
            background: rgba(96, 165, 250, .2);
        }

        .btn-sm {
            padding: 3px 8px;
            font-size: 10px;
        }

        /* Stats */
        .stats-bar {
            display: flex;
            gap: 8px;
            padding: 12px 32px;
            overflow-x: auto;
        }

        .stat-chip {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 6px 12px;
            border-radius: 9px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            font-size: 11px;
            font-weight: 500;
            white-space: nowrap;
        }

        .stat-count {
            font-weight: 700;
            font-size: 14px;
        }

        /* Grid */
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(360px, 1fr));
            gap: 14px;
            padding: 14px 32px 32px;
        }

        @media (max-width: 700px) {

            .grid,
            .stats-bar,
            .toolbar,
            .header {
                padding-left: 14px;
                padding-right: 14px;
            }

            .grid {
                grid-template-columns: 1fr;
            }
        }

        /* Cron Cards */
        .cron-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
            backdrop-filter: blur(10px);
            cursor: pointer;
            transition: all .25s cubic-bezier(.4, 0, .2, 1);
            animation: cardIn .3s cubic-bezier(.4, 0, .2, 1);
        }

        @keyframes cardIn {
            from {
                opacity: 0;
                transform: translateY(8px) scale(.97)
            }

            to {
                opacity: 1;
                transform: translateY(0) scale(1)
            }
        }

        .cron-card:hover {
            background: var(--bg-card-hover);
            border-color: var(--border-glow);
            transform: translateY(-2px);
            box-shadow: var(--shadow-glow);
        }

        .cron-card.updated {
            animation: pulse .5s ease-out;
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(251, 191, 36, .4)
            }

            100% {
                box-shadow: 0 0 0 10px rgba(251, 191, 36, 0)
            }
        }

        .card-top {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: 8px;
            margin-bottom: 6px;
        }

        .card-title {
            font-size: 13px;
            font-weight: 600;
            line-height: 1.4;
        }

        .enabled-badge {
            font-size: 9px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: .5px;
            padding: 2px 7px;
            border-radius: 5px;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .enabled-true {
            background: rgba(52, 211, 153, .12);
            color: var(--accent-emerald);
        }

        .enabled-false {
            background: rgba(251, 113, 133, .12);
            color: var(--accent-rose);
        }

        .card-agent {
            font-size: 10px;
            font-weight: 600;
            color: var(--accent-violet);
            margin-bottom: 6px;
        }

        .card-id {
            font-size: 9px;
            color: var(--text-muted);
            font-family: monospace;
            margin-bottom: 8px;
            word-break: break-all;
        }

        .schedule-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 9px;
            border-radius: 7px;
            background: rgba(251, 191, 36, .08);
            border: 1px solid rgba(251, 191, 36, .15);
            font-size: 11px;
            font-weight: 500;
            color: var(--accent-amber);
            margin-bottom: 8px;
        }

        .payload-section {
            background: rgba(255, 255, 255, .03);
            border-radius: 7px;
            padding: 8px 10px;
            margin-bottom: 8px;
            border: 1px solid var(--border);
        }

        .payload-label {
            font-size: 9px;
            font-weight: 700;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: .5px;
            margin-bottom: 3px;
        }

        .payload-text {
            font-size: 11px;
            color: var(--text-secondary);
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .run-info {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 6px;
        }

        .run-chip {
            font-size: 10px;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 3px;
        }

        .run-chip .label {
            color: var(--text-muted);
        }

        .status-ok {
            color: var(--accent-emerald);
        }

        .status-fail {
            color: var(--accent-rose);
        }

        .card-actions {
            display: flex;
            gap: 5px;
            margin-top: 8px;
            border-top: 1px solid var(--border);
            padding-top: 8px;
        }

        .card-owner {
            font-size: 9px;
            color: var(--text-muted);
            margin-top: 4px;
        }

        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-muted);
            grid-column: 1/-1;
        }

        .empty-state .icon {
            font-size: 40px;
            margin-bottom: 10px;
        }

        /* Toast */
        .toast-container {
            position: fixed;
            bottom: 16px;
            right: 16px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .toast {
            padding: 8px 14px;
            border-radius: 9px;
            font-size: 11px;
            font-weight: 500;
            backdrop-filter: blur(20px);
            background: var(--bg-card);
            border: 1px solid var(--border);
            box-shadow: var(--shadow-lg);
            animation: toastIn .3s ease-out, toastOut .3s ease-in 3.5s forwards;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        @keyframes toastIn {
            from {
                opacity: 0;
                transform: translateX(30px)
            }
        }

        @keyframes toastOut {
            to {
                opacity: 0;
                transform: translateX(30px)
            }
        }

        /* Event log */
        .event-log {
            position: fixed;
            bottom: 16px;
            left: 16px;
            width: 320px;
            max-height: 200px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 10px;
            backdrop-filter: blur(20px);
            overflow: hidden;
            z-index: 100;
            display: flex;
            flex-direction: column;
        }

        .event-log-header {
            padding: 6px 10px;
            font-size: 10px;
            font-weight: 700;
            color: var(--accent-cyan);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .event-log-body {
            padding: 6px;
            overflow-y: auto;
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .event-entry {
            font-size: 10px;
            color: var(--text-secondary);
            padding: 2px 5px;
            border-radius: 3px;
            background: rgba(255, 255, 255, .02);
            animation: eventIn .2s ease-out;
        }

        @keyframes eventIn {
            from {
                opacity: 0;
                transform: translateX(-6px)
            }
        }

        .event-entry .etype {
            color: var(--accent-cyan);
            font-weight: 600;
        }

        .event-entry .etime {
            color: var(--text-muted);
            font-size: 9px;
        }

        /* Modal overlay */
        .modal-overlay {
            position: fixed;
            inset: 0;
            z-index: 500;
            background: rgba(0, 0, 0, .6);
            backdrop-filter: blur(6px);
            display: none;
            justify-content: center;
            align-items: flex-start;
            padding: 40px 16px;
            overflow-y: auto;
        }

        .modal-overlay.active {
            display: flex;
            animation: fadeIn .2s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0
            }
        }

        .modal {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 14px;
            width: 100%;
            max-width: 700px;
            max-height: 85vh;
            display: flex;
            flex-direction: column;
            box-shadow: var(--shadow-lg);
            animation: modalIn .25s ease-out;
        }

        @keyframes modalIn {
            from {
                opacity: 0;
                transform: translateY(12px) scale(.97)
            }
        }

        .modal-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-shrink: 0;
        }

        .modal-header h2 {
            font-size: 15px;
            font-weight: 700;
        }

        .modal-close {
            width: 28px;
            height: 28px;
            border-radius: 7px;
            border: 1px solid var(--border);
            background: transparent;
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            transition: all .2s;
        }

        .modal-close:hover {
            background: rgba(251, 113, 133, .15);
            color: var(--accent-rose);
            border-color: var(--accent-rose);
        }

        .modal-body {
            padding: 16px 20px;
            overflow-y: auto;
            flex: 1;
        }

        /* Modal job summary */
        .modal-job-info {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 16px;
        }

        .modal-chip {
            font-size: 11px;
            padding: 4px 10px;
            border-radius: 7px;
            background: rgba(255, 255, 255, .04);
            border: 1px solid var(--border);
            color: var(--text-secondary);
        }

        /* Run history entries */
        .run-entry {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 12px 14px;
            margin-bottom: 10px;
            animation: cardIn .25s ease-out;
        }

        .run-entry.status-ok-bg {
            border-left: 3px solid var(--accent-emerald);
        }

        .run-entry.status-error-bg {
            border-left: 3px solid var(--accent-rose);
        }

        .run-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 6px;
            flex-wrap: wrap;
            gap: 6px;
        }

        .run-status-badge {
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: .5px;
            padding: 2px 7px;
            border-radius: 5px;
        }

        .run-status-ok {
            background: rgba(52, 211, 153, .12);
            color: var(--accent-emerald);
        }

        .run-status-error {
            background: rgba(251, 113, 133, .12);
            color: var(--accent-rose);
        }

        .run-meta {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            font-size: 10px;
            color: var(--text-muted);
            margin-bottom: 6px;
        }

        .run-meta span {
            display: flex;
            align-items: center;
            gap: 3px;
        }

        .run-summary {
            font-size: 12px;
            color: var(--text-secondary);
            line-height: 1.5;
            background: rgba(52, 211, 153, .04);
            border: 1px solid rgba(52, 211, 153, .1);
            border-radius: 7px;
            padding: 8px 10px;
            margin-top: 6px;
            white-space: pre-wrap;
            word-break: break-word;
        }

        .run-error {
            font-size: 12px;
            color: var(--accent-rose);
            line-height: 1.5;
            background: rgba(251, 113, 133, .06);
            border: 1px solid rgba(251, 113, 133, .12);
            border-radius: 7px;
            padding: 8px 10px;
            margin-top: 6px;
            white-space: pre-wrap;
            word-break: break-word;
        }

        .runs-empty {
            text-align: center;
            padding: 30px;
            color: var(--text-muted);
            font-size: 13px;
        }

        .runs-loading {
            text-align: center;
            padding: 30px;
            color: var(--accent-amber);
            font-size: 13px;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, .1);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }
    </style>
</head>

<body>
    <div class="bg-gradient"></div>
    <div class="app">
        <header class="header">
            <div class="header-left">
                <div class="logo">â°</div>
                <h1>Open<span>Claw</span> Cron Dashboard</h1>
            </div>
            <div class="ws-status">
                <div class="ws-dot" id="wsDot"></div>
                <span id="wsLabel">Disconnected</span>
            </div>
        </header>

        <div class="toolbar">
            <label>API</label>
            <input id="apiUrl" value="http://localhost:8000" style="width:180px" />
            <button class="btn" onclick="reconnect()">Connect</button>
            <button class="btn btn-blue" onclick="fetchCrons()">âŸ³ Refresh</button>
            <div class="sep"></div>
            <label>User</label>
            <input id="filterUser" placeholder="All users" style="width:120px" oninput="applyFilters()" />
            <div class="sep"></div>
            <label>Agent</label>
            <select id="filterAgent" onchange="applyFilters()">
                <option value="">All Agents</option>
            </select>
            <div class="sep"></div>
            <label>Status</label>
            <select id="filterStatus" onchange="applyFilters()">
                <option value="">All</option>
                <option value="active">Active</option>
                <option value="disabled">Disabled</option>
            </select>
        </div>

        <div class="stats-bar" id="statsBar"></div>
        <div class="grid" id="grid"></div>
    </div>

    <!-- Run History Modal -->
    <div class="modal-overlay" id="modalOverlay" onclick="if(event.target===this)closeModal()">
        <div class="modal">
            <div class="modal-header">
                <h2 id="modalTitle">Run History</h2>
                <button class="modal-close" onclick="closeModal()">âœ•</button>
            </div>
            <div class="modal-body" id="modalBody">
                <div class="runs-loading">Loading...</div>
            </div>
        </div>
    </div>

    <div class="event-log">
        <div class="event-log-header">
            <span>ğŸ“¡ WebSocket Events</span>
            <button class="btn btn-sm" onclick="clearLog()">Clear</button>
        </div>
        <div class="event-log-body" id="eventLog"></div>
    </div>

    <div class="toast-container" id="toasts"></div>

    <script>
        let allCrons = {};
        let ws = null;

        function api() { return document.getElementById('apiUrl').value.replace(/\/$/, ''); }
        function wsUrl() { return api().replace(/^http/, 'ws') + '/api/crons/ws'; }

        // â”€â”€ Fetch crons â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        async function fetchCrons() {
            try {
                const res = await fetch(api() + '/api/crons');
                const data = await res.json();
                allCrons = {};
                data.forEach(c => allCrons[c.job_id] = c);
                populateAgentFilter();
                applyFilters();
                toast('ğŸ“¥ Loaded ' + data.length + ' cron jobs');
            } catch (e) {
                toast('âŒ Fetch failed: ' + e.message);
            }
        }

        // â”€â”€ Filters â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function populateAgentFilter() {
            const sel = document.getElementById('filterAgent');
            const current = sel.value;
            const agents = [...new Set(Object.values(allCrons).map(c => c.agent_id).filter(Boolean))].sort();
            sel.innerHTML = '<option value="">All Agents</option>' + agents.map(a => '<option value="' + esc(a) + '"' + (a === current ? ' selected' : '') + '>' + esc(a) + '</option>').join('');
        }

        function getFiltered() {
            const userFilter = document.getElementById('filterUser').value.trim().toLowerCase();
            const agentFilter = document.getElementById('filterAgent').value;
            const statusFilter = document.getElementById('filterStatus').value;

            return Object.values(allCrons).filter(c => {
                if (userFilter && !(c.user_id || '').toLowerCase().includes(userFilter)) return false;
                if (agentFilter && c.agent_id !== agentFilter) return false;
                if (statusFilter === 'active' && !c.enabled) return false;
                if (statusFilter === 'disabled' && c.enabled) return false;
                return true;
            });
        }

        function applyFilters() { render(getFiltered()); }

        // â”€â”€ WebSocket â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function connectWs() {
            if (ws) { ws.close(); ws = null; }
            ws = new WebSocket(wsUrl());
            ws.onopen = () => {
                document.getElementById('wsDot').classList.add('connected');
                document.getElementById('wsLabel').textContent = 'Live';
                toast('ğŸŸ¢ WebSocket connected');
            };
            ws.onclose = () => {
                document.getElementById('wsDot').classList.remove('connected');
                document.getElementById('wsLabel').textContent = 'Disconnected';
                setTimeout(() => { if (!ws || ws.readyState === WebSocket.CLOSED) connectWs(); }, 3000);
            };
            ws.onerror = () => { };
            ws.onmessage = (evt) => { try { handleEvent(JSON.parse(evt.data)); } catch { } };
        }

        function handleEvent(msg) {
            const { event, data } = msg;
            logEvent(event, data);
            if (event === 'cron_created') { fetchCrons(); toast('âœ¨ Cron created: ' + (data.name || data.job_id)); }
            else if (event === 'cron_updated') {
                fetchCrons();
                toast('ğŸ“ Cron updated: ' + data.job_id);
                setTimeout(() => {
                    const el = document.querySelector('[data-job-id="' + data.job_id + '"]');
                    if (el) { el.classList.add('updated'); setTimeout(() => el.classList.remove('updated'), 700); }
                }, 300);
            }
            else if (event === 'cron_deleted') { delete allCrons[data.job_id]; applyFilters(); toast('ğŸ—‘ï¸ Deleted: ' + data.job_id); }
            else if (event === 'cron_triggered') { toast('ğŸš€ Triggered: ' + data.job_id); setTimeout(fetchCrons, 1500); }
        }

        function reconnect() { fetchCrons(); connectWs(); }

        // â”€â”€ Render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function render(list) {
            const enabled = list.filter(c => c.enabled);
            const disabled = list.filter(c => !c.enabled);
            const total = Object.values(allCrons).length;

            document.getElementById('statsBar').innerHTML =
                '<div class="stat-chip"><span class="stat-count">' + total + '</span> Total</div>' +
                '<div class="stat-chip"><span class="stat-count">' + list.length + '</span> Showing</div>' +
                '<div class="stat-chip"><span class="stat-count" style="color:var(--accent-emerald)">' + enabled.length + '</span> Active</div>' +
                '<div class="stat-chip"><span class="stat-count" style="color:var(--accent-rose)">' + disabled.length + '</span> Disabled</div>';

            if (list.length === 0) {
                document.getElementById('grid').innerHTML = '<div class="empty-state"><div class="icon">â°</div><p>No cron jobs match the current filters.</p></div>';
                return;
            }
            list.sort((a, b) => (b.enabled - a.enabled) || a.name.localeCompare(b.name));
            document.getElementById('grid').innerHTML = list.map(renderCard).join('');
        }

        function renderCard(c) {
            const sched = c.schedule_human || formatSchedule(c.schedule);
            const lastRun = c.last_run_at ? timeAgo(c.last_run_at) : 'Never';
            const nextRun = c.next_run_at ? timeAgo(c.next_run_at) : 'â€”';
            const statusCls = c.last_run_status === 'ok' ? 'status-ok' : (c.last_run_status ? 'status-fail' : '');

            return '<div class="cron-card" data-job-id="' + c.job_id + '" onclick="openRunHistory(\'' + c.job_id + '\')">' +
                '<div class="card-top">' +
                '<div class="card-title">' + esc(c.name) + '</div>' +
                '<span class="enabled-badge enabled-' + c.enabled + '">' + (c.enabled ? 'â— Active' : 'â— Disabled') + '</span>' +
                '</div>' +
                '<div class="card-agent">ğŸ¤– ' + esc(c.agent_id) + '</div>' +
                '<div class="card-id">' + c.job_id + '</div>' +
                '<div class="schedule-badge">â± ' + esc(sched) + '</div>' +
                '<div class="payload-section">' +
                '<div class="payload-label">Payload</div>' +
                '<div class="payload-text">' + esc(c.payload_message) + '</div>' +
                '</div>' +
                '<div class="run-info">' +
                '<div class="run-chip"><span class="label">Last:</span> ' + lastRun + '</div>' +
                '<div class="run-chip"><span class="label">Next:</span> ' + nextRun + '</div>' +
                (c.last_run_status ? '<div class="run-chip"><span class="label">Status:</span> <span class="' + statusCls + '">' + esc(c.last_run_status) + '</span></div>' : '') +
                '</div>' +
                ((c.total_runs !== undefined && c.total_runs !== null) ?
                    '<div class="run-info" style="margin-top:2px; border-top: 1px solid rgba(255,255,255,0.03); padding-top:6px;">' +
                    '<div class="run-chip" title="Total runs"><span class="label">Runs:</span> ' + c.total_runs + '</div>' +
                    (c.total_runs > 0 ?
                        '<div class="run-chip" title="Success rate"><span class="label">Success:</span> ' + Math.round((c.success_rate || 0) * 100) + '%</div>' +
                        '<div class="run-chip" title="Avg duration"><span class="label">Avg time:</span> ' + (c.avg_duration_ms > 60000 ? (c.avg_duration_ms / 60000).toFixed(1) + 'm' : (c.avg_duration_ms / 1000).toFixed(1) + 's') + '</div>'
                        : '') +
                    '</div>'
                    : '') +
                (c.user_id ? '<div class="card-owner">ğŸ‘¤ ' + esc(c.user_id) + '</div>' : '<div class="card-owner">ğŸ‘¤ No owner (CLI-created)</div>') +
                '<div class="card-actions">' +
                '<button class="btn btn-blue btn-sm" onclick="event.stopPropagation();openRunHistory(\'' + c.job_id + '\')">ğŸ“œ History</button>' +
                '<button class="btn btn-sm" onclick="event.stopPropagation();triggerJob(\'' + c.job_id + '\')">â–¶ Trigger</button>' +
                '<button class="btn btn-sm" onclick="event.stopPropagation();toggleJob(\'' + c.job_id + '\',' + !c.enabled + ')">' + (c.enabled ? 'â¸ Disable' : 'â–¶ Enable') + '</button>' +
                '<button class="btn btn-danger btn-sm" onclick="event.stopPropagation();deleteJob(\'' + c.job_id + '\')">âœ• Delete</button>' +
                '</div>' +
                '</div>';
        }

        // â”€â”€ Run History Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        async function openRunHistory(jobId) {
            const cron = allCrons[jobId];
            document.getElementById('modalTitle').textContent = 'ğŸ“œ Run History â€” ' + (cron ? cron.name : jobId);
            document.getElementById('modalBody').innerHTML = '<div class="runs-loading">Loading run history...</div>';
            document.getElementById('modalOverlay').classList.add('active');

            if (cron) {
                document.getElementById('modalBody').innerHTML =
                    '<div class="modal-job-info">' +
                    '<div class="modal-chip">ğŸ¤– ' + esc(cron.agent_id) + '</div>' +
                    '<div class="modal-chip">â± ' + esc(formatSchedule(cron.schedule)) + '</div>' +
                    '<div class="modal-chip">' + (cron.enabled ? 'ğŸŸ¢ Active' : 'ğŸ”´ Disabled') + '</div>' +
                    (cron.user_id ? '<div class="modal-chip">ğŸ‘¤ ' + esc(cron.user_id) + '</div>' : '') +
                    '</div>' +
                    '<div id="runsContainer"><div class="runs-loading">Loading run history...</div></div>';
            }

            try {
                const res = await fetch(api() + '/api/crons/' + jobId + '/detail');
                const data = await res.json();
                let entries = [];
                if (data && data.runs) {
                    entries = data.runs;
                } else if (Array.isArray(data)) {
                    entries = data;
                } else if (data.entries) {
                    entries = data.entries;
                } else if (data.raw) {
                    try { const parsed = JSON.parse(data.raw); entries = parsed.entries || parsed.runs || (Array.isArray(parsed) ? parsed : []); } catch { }
                }

                const container = document.getElementById('runsContainer') || document.getElementById('modalBody');
                if (entries.length === 0) {
                    container.innerHTML = '<div class="runs-empty">No run history found for this job.</div>';
                    return;
                }

                // Sort newest first
                entries.sort((a, b) => (b.ts || b.runAtMs || 0) - (a.ts || a.runAtMs || 0));
                container.innerHTML = entries.map(renderRunEntry).join('');
            } catch (e) {
                const container = document.getElementById('runsContainer') || document.getElementById('modalBody');
                container.innerHTML = '<div class="runs-empty">Failed to load run history: ' + esc(e.message) + '</div>';
            }
        }

        function renderRunEntry(entry) {
            const isOk = entry.status === 'ok' || entry.status === 'success';
            const bgClass = isOk ? 'status-ok-bg' : 'status-error-bg';
            const badgeClass = isOk ? 'run-status-ok' : 'run-status-error';
            const ts = entry.runAtMs || entry.ts;
            const dur = entry.durationMs;

            let html = '<div class="run-entry ' + bgClass + '">';
            html += '<div class="run-header">';
            html += '<span class="run-status-badge ' + badgeClass + '">' + (entry.status || 'unknown').toUpperCase() + '</span>';
            html += '<span style="font-size:11px;color:var(--text-muted)">' + (ts ? new Date(ts).toLocaleString() : 'â€”') + '</span>';
            html += '</div>';

            html += '<div class="run-meta">';
            if (dur) html += '<span>â± ' + (dur > 60000 ? (dur / 60000).toFixed(1) + ' min' : (dur / 1000).toFixed(1) + 's') + '</span>';
            if (entry.model) html += '<span>ğŸ§  ' + esc(entry.model) + '</span>';
            if (entry.provider) html += '<span>â˜ï¸ ' + esc(entry.provider) + '</span>';
            if (entry.usage) {
                const u = entry.usage;
                html += '<span>ğŸ“Š ' + (u.total_tokens || ((u.input_tokens || 0) + (u.output_tokens || 0))).toLocaleString() + ' tokens</span>';
            }
            if (entry.action) html += '<span>ğŸ“Œ ' + esc(entry.action) + '</span>';
            html += '</div>';

            if (entry.tasks && entry.tasks.length > 0) {
                html += '<div style="margin-top:10px; display:flex; flex-direction:column; gap:6px;">';
                entry.tasks.forEach(task => {
                    const tOk = task.status === 'success';
                    const tIcon = tOk ? 'âœ…' : (task.status === 'error' ? 'âŒ' : 'â³');
                    const tColor = tOk ? 'var(--accent-emerald)' : (task.status === 'error' ? 'var(--accent-rose)' : 'var(--accent-amber)');
                    const tooltip = task.description ? ` title="${esc(task.description).replace(/"/g, '&quot;')}"` : '';
                    html += `<div style="padding:6px 10px; background:rgba(255,255,255,0.02); border:1px solid rgba(255,255,255,0.06); border-radius:6px; font-size:11px;"${tooltip}>`;
                    html += `<div style="display:flex; justify-content:space-between; align-items:center;">`;
                    html += `<strong style="color:var(--text-primary)">${tIcon} ${esc(task.name || 'Unnamed task')}</strong>`;
                    html += `<span style="color:${tColor}; font-weight:600; text-transform:uppercase; font-size:9px; letter-spacing:0.5px;">${esc(task.status)}</span>`;
                    html += `</div>`;
                    if (task.error) {
                        html += `<div style="margin-top:4px; color:var(--accent-rose); font-size:10px;">${esc(task.error)}</div>`;
                    }
                    if ((task.integrations && task.integrations.length > 0) || (task.context_sources && task.context_sources.length > 0)) {
                        html += `<div style="margin-top:6px; display:flex; gap:4px; flex-wrap:wrap;">`;
                        (task.integrations || []).forEach(i => html += `<span style="padding:2px 6px; background:rgba(129,140,248,0.15); color:var(--accent-indigo); border-radius:4px; font-size:9px;">ğŸ”Œ ${esc(i.name)}</span>`);
                        (task.context_sources || []).forEach(c => html += `<span style="padding:2px 6px; background:rgba(96,165,250,0.15); color:var(--accent-blue); border-radius:4px; font-size:9px;">ğŸ“š ${esc(c.name)}</span>`);
                        html += `</div>`;
                    }
                    html += `</div>`;
                });

                if ((entry.global_integrations && entry.global_integrations.length > 0) || (entry.global_context_sources && entry.global_context_sources.length > 0)) {
                    html += `<div style="margin-top:8px; font-size:10px; color:var(--text-muted); display:flex; gap:6px; flex-wrap:wrap; align-items:center;">`;
                    html += `<span>Global Usage:</span>`;
                    (entry.global_integrations || []).forEach(i => html += `<span style="color:var(--text-secondary)">ğŸ”Œ ${esc(i.name)}</span>`);
                    (entry.global_context_sources || []).forEach(c => html += `<span style="color:var(--text-secondary)">ğŸ“š ${esc(c.name)}</span>`);
                    html += `</div>`;
                }

                html += '</div>';
            } else if (entry.summary) {
                html += '<div class="run-summary"><strong>âœ… Response:</strong>\n' + esc(entry.summary) + '</div>';
            }
            if (entry.error && (!entry.tasks || entry.tasks.length === 0)) {
                html += '<div class="run-error"><strong>âŒ Error:</strong>\n' + esc(entry.error) + '</div>';
            }

            html += '</div>';
            return html;
        }

        function closeModal() {
            document.getElementById('modalOverlay').classList.remove('active');
        }

        // â”€â”€ Actions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        async function triggerJob(id) {
            try { await fetch(api() + '/api/crons/' + id + '/trigger', { method: 'POST' }); toast('ğŸš€ Triggered ' + id); }
            catch (e) { toast('âŒ ' + e.message); }
        }

        async function toggleJob(id, enabled) {
            try {
                await fetch(api() + '/api/crons/' + id, { method: 'PATCH', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ enabled }) });
                toast((enabled ? 'â–¶ Enabled ' : 'â¸ Disabled ') + id);
                fetchCrons();
            } catch (e) { toast('âŒ ' + e.message); }
        }

        async function deleteJob(id) {
            if (!confirm('Delete cron job ' + id + '?')) return;
            try { await fetch(api() + '/api/crons/' + id, { method: 'DELETE' }); toast('ğŸ—‘ï¸ Deleted ' + id); delete allCrons[id]; applyFilters(); }
            catch (e) { toast('âŒ ' + e.message); }
        }

        // â”€â”€ Event log â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function logEvent(type, data) {
            const el = document.getElementById('eventLog');
            const time = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = 'event-entry';
            entry.innerHTML = '<span class="etime">' + time + '</span> <span class="etype">' + type + '</span> ' + JSON.stringify(data).substring(0, 70);
            el.prepend(entry);
            while (el.children.length > 50) el.removeChild(el.lastChild);
        }
        function clearLog() { document.getElementById('eventLog').innerHTML = ''; }

        // â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function esc(s) { const d = document.createElement('div'); d.textContent = s || ''; return d.innerHTML; }

        function formatSchedule(sched) {
            if (!sched) return 'Unknown';
            if (sched.kind === 'every') {
                const ms = sched.everyMs || sched.every;
                if (!ms) return 'every ?';
                if (typeof ms === 'string' && !/^\d+$/.test(ms)) return 'Every ' + ms;
                const s = Number(ms) / 1000;
                if (s < 60) return 'Every ' + s + 's';
                if (s < 3600) return 'Every ' + Math.round(s / 60) + ' min';
                if (s < 86400) return 'Every ' + Math.round(s / 3600) + ' hr';
                return 'Every ' + Math.round(s / 86400) + ' day';
            }
            if (sched.kind === 'cron') return 'Cron: ' + (sched.expr || sched.cron || '?') + (sched.tz ? ' (' + sched.tz + ')' : '');
            if (sched.kind === 'at') return 'Once: ' + (sched.at || sched.expr || '?');
            return JSON.stringify(sched);
        }

        function timeAgo(val) {
            if (!val) return '';
            const ts = typeof val === 'number' ? val : new Date(val).getTime();
            const diff = Date.now() - ts;
            if (diff < 0) {
                const abs = Math.abs(diff);
                const mins = Math.floor(abs / 60000);
                if (mins < 1) return 'in <1m';
                if (mins < 60) return 'in ' + mins + 'm';
                return 'in ' + Math.floor(mins / 60) + 'h';
            }
            const mins = Math.floor(diff / 60000);
            if (mins < 1) return 'just now';
            if (mins < 60) return mins + 'm ago';
            const hrs = Math.floor(mins / 60);
            if (hrs < 24) return hrs + 'h ago';
            return Math.floor(hrs / 24) + 'd ago';
        }

        function toast(text) {
            const el = document.createElement('div');
            el.className = 'toast'; el.textContent = text;
            document.getElementById('toasts').appendChild(el);
            setTimeout(() => el.remove(), 4000);
        }

        // Close modal on Escape
        document.addEventListener('keydown', e => { if (e.key === 'Escape') closeModal(); });

        // â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        fetchCrons();
        connectWs();
    </script>
</body>

</html>