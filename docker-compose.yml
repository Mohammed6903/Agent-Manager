# ── OpenClaw API — Docker Compose ────────────────────────────────────────────
#
# Architecture:
#
#   Host :18789 ──► OpenClaw Gateway (chat/completions, control UI, channels)
#   Host :8001  ──► FastAPI          (agent-manager API, gmail-auth API)
#
# Both services share the OpenClaw state directory so the FastAPI CLI
# client can read/write agent configs managed by the gateway.
#
# Usage:
#   cp .env.example .env   # fill in secrets
#   docker compose up --build

services:
  # ── OpenClaw Gateway ───────────────────────────────────────────────────────
  # Built from npm (openclaw@latest).  Exposes the gateway on :18789.
  openclaw:
    build:
      context: .
      dockerfile: Dockerfile.openclaw
    ports:
      - "${OPENCLAW_PORT:-18789}:18789"
    volumes:
      - openclaw-data:/root/.openclaw
    environment:
      OPENCLAW_GATEWAY_TOKEN: ${OPENCLAW_GATEWAY_TOKEN}
    networks:
      - internal
    restart: unless-stopped

  # ── FastAPI Application ────────────────────────────────────────────────────
  # Agent-manager + Gmail-auth APIs.
  fastapi:
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "${APP_PORT:-8001}:${APP_PORT:-8001}"
    env_file: .env
    environment:
      # Docker-internal overrides (take precedence over .env values)
      OPENCLAW_GATEWAY_URL: http://openclaw:18789
      OPENCLAW_GATEWAY_TOKEN: ${OPENCLAW_GATEWAY_TOKEN}
      OPENCLAW_STATE_DIR: /root/.openclaw
      DATABASE_URL: postgresql://${POSTGRES_USER:-openclaw}:${POSTGRES_PASSWORD:-openclaw}@postgres:5432/${POSTGRES_DB:-openclaw}
      SERVER_HOST: "0.0.0.0"
      SERVER_PORT: "${APP_PORT:-8001}"
      SERVER_URL: "http://localhost:${APP_PORT:-8001}"
    volumes:
      - openclaw-data:/root/.openclaw
      # Mount Google OAuth credentials at runtime (not baked into image)
      - ./gmail_service/credentials_for_local.json:/app/gmail_service/credentials_for_local.json:ro
    depends_on:
      openclaw:
        condition: service_started
      postgres:
        condition: service_healthy
    networks:
      - internal
    restart: unless-stopped

  # ── PostgreSQL ─────────────────────────────────────────────────────────────
  postgres:
    image: postgres:16-alpine
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-openclaw}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-openclaw}
      POSTGRES_DB: ${POSTGRES_DB:-openclaw}
    volumes:
      - postgres-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-openclaw}"]
      interval: 5s
      timeout: 3s
      retries: 5
    networks:
      - internal
    restart: unless-stopped

volumes:
  openclaw-data:
  postgres-data:

networks:
  internal:
    driver: bridge
