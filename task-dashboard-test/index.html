<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>OpenClaw Task Board</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet" />
  <style>
    :root {
      --bg-primary: #0a0e1a;
      --bg-secondary: #111827;
      --bg-card: rgba(17, 24, 39, 0.7);
      --bg-card-hover: rgba(17, 24, 39, 0.9);
      --border: rgba(255, 255, 255, 0.06);
      --border-glow: rgba(99, 102, 241, 0.3);
      --text-primary: #f1f5f9;
      --text-secondary: #94a3b8;
      --text-muted: #64748b;
      --accent-indigo: #818cf8;
      --accent-blue: #60a5fa;
      --accent-emerald: #34d399;
      --accent-amber: #fbbf24;
      --accent-rose: #fb7185;
      --accent-violet: #a78bfa;
      --gradient-1: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --gradient-2: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      --gradient-3: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      --gradient-4: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
      --shadow-lg: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
      --shadow-glow: 0 0 40px rgba(99, 102, 241, 0.15);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Inter', -apple-system, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      min-height: 100vh;
      overflow-x: hidden;
    }

    /* â”€â”€ Animated background â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .bg-gradient {
      position: fixed;
      inset: 0;
      z-index: 0;
      overflow: hidden;
    }
    .bg-gradient::before, .bg-gradient::after {
      content: '';
      position: absolute;
      border-radius: 50%;
      filter: blur(120px);
      opacity: 0.15;
      animation: float 20s ease-in-out infinite;
    }
    .bg-gradient::before {
      width: 600px; height: 600px;
      background: var(--gradient-1);
      top: -100px; left: -100px;
    }
    .bg-gradient::after {
      width: 500px; height: 500px;
      background: var(--gradient-3);
      bottom: -100px; right: -100px;
      animation-delay: -10s;
    }
    @keyframes float {
      0%, 100% { transform: translate(0, 0) scale(1); }
      33% { transform: translate(50px, -50px) scale(1.1); }
      66% { transform: translate(-30px, 30px) scale(0.95); }
    }

    /* â”€â”€ Layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .app { position: relative; z-index: 1; }

    .header {
      padding: 24px 40px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid var(--border);
      backdrop-filter: blur(20px);
      background: rgba(10, 14, 26, 0.6);
      position: sticky;
      top: 0;
      z-index: 100;
    }
    .header-left {
      display: flex;
      align-items: center;
      gap: 16px;
    }
    .logo {
      width: 40px; height: 40px;
      background: var(--gradient-1);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      font-weight: 800;
      box-shadow: var(--shadow-glow);
    }
    .header h1 {
      font-size: 20px;
      font-weight: 700;
      letter-spacing: -0.5px;
    }
    .header h1 span { color: var(--accent-indigo); }

    .ws-status {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      font-weight: 500;
      color: var(--text-secondary);
      padding: 8px 16px;
      border-radius: 100px;
      background: rgba(255,255,255,0.04);
      border: 1px solid var(--border);
    }
    .ws-dot {
      width: 8px; height: 8px;
      border-radius: 50%;
      background: var(--accent-rose);
      transition: background 0.3s;
    }
    .ws-dot.connected { background: var(--accent-emerald); box-shadow: 0 0 8px var(--accent-emerald); }

    .stats-bar {
      display: flex;
      gap: 12px;
      padding: 16px 40px;
      overflow-x: auto;
    }
    .stat-chip {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 18px;
      border-radius: 12px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      font-size: 13px;
      font-weight: 500;
      white-space: nowrap;
      backdrop-filter: blur(10px);
      transition: all 0.2s;
    }
    .stat-chip:hover { border-color: var(--border-glow); }
    .stat-count {
      font-weight: 700;
      font-size: 16px;
    }

    .board {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 20px;
      padding: 20px 40px 40px;
      min-height: calc(100vh - 160px);
    }

    @media (max-width: 1200px) { .board { grid-template-columns: repeat(2, 1fr); } }
    @media (max-width: 700px) { .board { grid-template-columns: 1fr; } .header, .stats-bar, .board { padding-left: 16px; padding-right: 16px; } }

    /* â”€â”€ Columns â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .column {
      background: rgba(255, 255, 255, 0.02);
      border: 1px solid var(--border);
      border-radius: 16px;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    .column-header {
      padding: 16px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid var(--border);
    }
    .column-title {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 14px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .column-icon {
      width: 28px; height: 28px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
    }
    .column-count {
      font-size: 12px;
      font-weight: 700;
      padding: 2px 10px;
      border-radius: 100px;
      background: rgba(255,255,255,0.06);
    }
    .column-body {
      padding: 12px;
      flex: 1;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .col-assigned .column-icon { background: rgba(96, 165, 250, 0.15); color: var(--accent-blue); }
    .col-in_progress .column-icon { background: rgba(251, 191, 36, 0.15); color: var(--accent-amber); }
    .col-completed .column-icon { background: rgba(52, 211, 153, 0.15); color: var(--accent-emerald); }
    .col-error .column-icon { background: rgba(251, 113, 133, 0.15); color: var(--accent-rose); }

    /* â”€â”€ Task cards â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .task-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      cursor: pointer;
      transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
      backdrop-filter: blur(10px);
      animation: cardIn 0.35s cubic-bezier(0.4, 0, 0.2, 1);
    }
    @keyframes cardIn {
      from { opacity: 0; transform: translateY(12px) scale(0.97); }
      to { opacity: 1; transform: translateY(0) scale(1); }
    }
    .task-card:hover {
      background: var(--bg-card-hover);
      border-color: var(--border-glow);
      transform: translateY(-2px);
      box-shadow: var(--shadow-glow);
    }
    .task-card.updated {
      animation: pulse 0.6s ease-out;
    }
    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(129, 140, 248, 0.5); }
      100% { box-shadow: 0 0 0 12px rgba(129, 140, 248, 0); }
    }

    .card-top {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 8px;
    }
    .card-title {
      font-size: 14px;
      font-weight: 600;
      line-height: 1.4;
      color: var(--text-primary);
    }
    .difficulty-badge {
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      padding: 3px 8px;
      border-radius: 6px;
      white-space: nowrap;
      flex-shrink: 0;
    }
    .diff-low { background: rgba(52, 211, 153, 0.12); color: var(--accent-emerald); }
    .diff-medium { background: rgba(251, 191, 36, 0.12); color: var(--accent-amber); }
    .diff-high { background: rgba(251, 113, 133, 0.12); color: var(--accent-rose); }

    .card-desc {
      font-size: 12px;
      color: var(--text-secondary);
      line-height: 1.5;
      margin-bottom: 10px;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .card-agent {
      font-size: 11px;
      font-weight: 600;
      color: var(--accent-violet);
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    /* Sub-tasks */
    .subtasks { margin-bottom: 10px; }
    .subtask-progress {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 6px;
    }
    .progress-bar {
      flex: 1;
      height: 4px;
      border-radius: 4px;
      background: rgba(255,255,255,0.06);
      overflow: hidden;
    }
    .progress-fill {
      height: 100%;
      border-radius: 4px;
      background: var(--gradient-4);
      transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .progress-text {
      font-size: 11px;
      font-weight: 600;
      color: var(--text-muted);
      white-space: nowrap;
    }
    .subtask-list {
      list-style: none;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .subtask-item {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      color: var(--text-secondary);
      padding: 4px 0;
    }
    .subtask-check {
      width: 14px; height: 14px;
      border-radius: 4px;
      border: 1.5px solid var(--text-muted);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 9px;
      flex-shrink: 0;
    }
    .subtask-item.done .subtask-check {
      background: var(--accent-emerald);
      border-color: var(--accent-emerald);
      color: #000;
    }
    .subtask-item.done .subtask-text { text-decoration: line-through; color: var(--text-muted); }

    /* Integrations & context */
    .card-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-bottom: 8px;
    }
    .tag {
      font-size: 10px;
      font-weight: 600;
      padding: 3px 8px;
      border-radius: 6px;
      background: rgba(129, 140, 248, 0.1);
      color: var(--accent-indigo);
    }

    /* Issues */
    .issues-section {
      margin-top: 8px;
      border-top: 1px solid var(--border);
      padding-top: 8px;
    }
    .issues-title {
      font-size: 11px;
      font-weight: 700;
      color: var(--accent-rose);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 6px;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .issue-item {
      font-size: 12px;
      color: var(--text-secondary);
      padding: 6px 8px;
      border-radius: 6px;
      background: rgba(251, 113, 133, 0.06);
      margin-bottom: 4px;
      display: flex;
      align-items: flex-start;
      gap: 8px;
    }
    .issue-item.resolved {
      background: rgba(52, 211, 153, 0.06);
    }
    .resolve-btn {
      font-size: 10px;
      font-weight: 700;
      padding: 3px 10px;
      border-radius: 6px;
      border: 1px solid rgba(251, 113, 133, 0.3);
      background: rgba(251, 113, 133, 0.1);
      color: var(--accent-rose);
      cursor: pointer;
      white-space: nowrap;
      flex-shrink: 0;
      transition: all 0.2s;
    }
    .resolve-btn:hover {
      background: rgba(251, 113, 133, 0.25);
      border-color: var(--accent-rose);
    }
    .resolve-btn.resolved {
      border-color: rgba(52, 211, 153, 0.3);
      background: rgba(52, 211, 153, 0.1);
      color: var(--accent-emerald);
      cursor: default;
    }

    .card-time {
      font-size: 10px;
      color: var(--text-muted);
      margin-top: 8px;
      display: flex;
      justify-content: space-between;
    }

    /* â”€â”€ Empty state â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .empty-col {
      text-align: center;
      padding: 32px 16px;
      color: var(--text-muted);
      font-size: 13px;
    }
    .empty-col .icon { font-size: 28px; margin-bottom: 8px; }

    /* â”€â”€ Toast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .toast-container {
      position: fixed;
      bottom: 24px;
      right: 24px;
      z-index: 1000;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .toast {
      padding: 12px 20px;
      border-radius: 12px;
      font-size: 13px;
      font-weight: 500;
      backdrop-filter: blur(20px);
      background: var(--bg-card);
      border: 1px solid var(--border);
      box-shadow: var(--shadow-lg);
      animation: toastIn 0.3s ease-out, toastOut 0.3s ease-in 3.5s forwards;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    @keyframes toastIn { from { opacity: 0; transform: translateX(30px); } }
    @keyframes toastOut { to { opacity: 0; transform: translateX(30px); } }

    /* Scrollbar */
    .column-body::-webkit-scrollbar { width: 4px; }
    .column-body::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 4px; }
    .column-body::-webkit-scrollbar-track { background: transparent; }

    /* Config bar */
    .config-bar {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 40px;
      background: rgba(255,255,255,0.02);
      border-bottom: 1px solid var(--border);
    }
    .config-bar label { font-size: 12px; color: var(--text-muted); font-weight: 500; }
    .config-bar input, .config-bar select {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 6px 12px;
      font-size: 12px;
      color: var(--text-primary);
      font-family: inherit;
      outline: none;
      transition: border-color 0.2s;
    }
    .config-bar input:focus, .config-bar select:focus { border-color: var(--accent-indigo); }
    .config-bar select option { background: var(--bg-secondary); }
    .connect-btn {
      padding: 6px 16px;
      border-radius: 8px;
      border: 1px solid var(--accent-indigo);
      background: rgba(129, 140, 248, 0.1);
      color: var(--accent-indigo);
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    .connect-btn:hover { background: rgba(129, 140, 248, 0.2); }
  </style>
</head>
<body>
  <div class="bg-gradient"></div>
  <div class="app">
    <header class="header">
      <div class="header-left">
        <div class="logo">ğŸ¦</div>
        <h1>Open<span>Claw</span> Task Board</h1>
      </div>
      <div class="ws-status">
        <div class="ws-dot" id="wsDot"></div>
        <span id="wsLabel">Disconnected</span>
      </div>
    </header>

    <div class="config-bar">
      <label>API</label>
      <input id="apiUrl" value="http://localhost:8000" style="width:240px" />
      <label>Agent</label>
      <input id="agentFilter" placeholder="all" style="width:100px" />
      <label>Status</label>
      <select id="statusFilter">
        <option value="">All</option>
        <option value="assigned">Assigned</option>
        <option value="in_progress">In Progress</option>
        <option value="completed">Completed</option>
        <option value="error">Error</option>
      </select>
      <button class="connect-btn" onclick="reconnect()">Connect</button>
    </div>

    <div class="stats-bar" id="statsBar"></div>

    <div class="board">
      <div class="column col-assigned">
        <div class="column-header">
          <div class="column-title"><div class="column-icon">ğŸ“‹</div> Assigned</div>
          <div class="column-count" id="count-assigned">0</div>
        </div>
        <div class="column-body" id="col-assigned"></div>
      </div>
      <div class="column col-in_progress">
        <div class="column-header">
          <div class="column-title"><div class="column-icon">âš¡</div> In Progress</div>
          <div class="column-count" id="count-in_progress">0</div>
        </div>
        <div class="column-body" id="col-in_progress"></div>
      </div>
      <div class="column col-completed">
        <div class="column-header">
          <div class="column-title"><div class="column-icon">âœ…</div> Completed</div>
          <div class="column-count" id="count-completed">0</div>
        </div>
        <div class="column-body" id="col-completed"></div>
      </div>
      <div class="column col-error">
        <div class="column-header">
          <div class="column-title"><div class="column-icon">ğŸš¨</div> Blocked</div>
          <div class="column-count" id="count-error">0</div>
        </div>
        <div class="column-body" id="col-error"></div>
      </div>
    </div>
  </div>

  <div class="toast-container" id="toasts"></div>

<script>
// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let tasks = {};
let ws = null;

function apiUrl() { return document.getElementById('apiUrl').value.replace(/\/$/, ''); }
function wsUrl() { return apiUrl().replace(/^http/, 'ws') + '/api/tasks/ws'; }

// â”€â”€ REST: Fetch tasks â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function fetchTasks() {
  const base = apiUrl() + '/api/tasks';
  const params = new URLSearchParams();
  const agent = document.getElementById('agentFilter').value.trim();
  const status = document.getElementById('statusFilter').value;
  if (agent) params.set('agent_id', agent);
  if (status) params.set('status', status);

  try {
    const res = await fetch(base + '?' + params.toString());
    const data = await res.json();
    tasks = {};
    data.forEach(t => tasks[t.id] = t);
    renderBoard();
    toast('ğŸ“¥ Loaded ' + data.length + ' tasks');
  } catch (e) {
    toast('âŒ Failed to fetch tasks: ' + e.message);
  }
}

// â”€â”€ WebSocket â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function connectWs() {
  if (ws) { ws.close(); ws = null; }

  const url = wsUrl();
  ws = new WebSocket(url);

  ws.onopen = () => {
    document.getElementById('wsDot').classList.add('connected');
    document.getElementById('wsLabel').textContent = 'Live';
    toast('ğŸŸ¢ WebSocket connected');
  };

  ws.onclose = () => {
    document.getElementById('wsDot').classList.remove('connected');
    document.getElementById('wsLabel').textContent = 'Disconnected';
    // Auto-reconnect after 3s
    setTimeout(() => { if (!ws || ws.readyState === WebSocket.CLOSED) connectWs(); }, 3000);
  };

  ws.onerror = () => {};

  ws.onmessage = (evt) => {
    try {
      const msg = JSON.parse(evt.data);
      handleWsEvent(msg);
    } catch {}
  };
}

function handleWsEvent(msg) {
  const { event, data } = msg;

  if (event === 'task_created') {
    tasks[data.id] = data;
    toast('âœ¨ New task: ' + data.title);
  } else if (event === 'task_updated') {
    const prev = tasks[data.id];
    tasks[data.id] = data;
    if (prev && prev.status !== data.status) {
      toast('ğŸ”„ ' + data.title + ' â†’ ' + formatStatus(data.status));
    } else {
      toast('ğŸ“ Updated: ' + data.title);
    }
    // Pulse animation
    setTimeout(() => {
      const el = document.querySelector(`[data-task-id="${data.id}"]`);
      if (el) { el.classList.add('updated'); setTimeout(() => el.classList.remove('updated'), 700); }
    }, 50);
  } else if (event === 'task_deleted') {
    delete tasks[data.id];
    toast('ğŸ—‘ï¸ Deleted: ' + data.title);
  } else if (event === 'issue_resolved') {
    tasks[data.task.id] = data.task;
    toast('âœ… Issue resolved on: ' + data.task.title);
  }

  renderBoard();
}

function reconnect() {
  fetchTasks();
  connectWs();
}

// â”€â”€ Render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderBoard() {
  const columns = { assigned: [], in_progress: [], completed: [], error: [] };

  Object.values(tasks).forEach(t => {
    if (columns[t.status]) columns[t.status].push(t);
  });

  // Sort: newest first
  for (const col of Object.values(columns)) {
    col.sort((a, b) => new Date(b.updated_at || b.created_at) - new Date(a.updated_at || a.created_at));
  }

  for (const [status, list] of Object.entries(columns)) {
    const container = document.getElementById('col-' + status);
    const countEl = document.getElementById('count-' + status);
    countEl.textContent = list.length;

    if (list.length === 0) {
      container.innerHTML = `<div class="empty-col"><div class="icon">${emptyIcon(status)}</div><div>No tasks</div></div>`;
    } else {
      container.innerHTML = list.map(t => renderCard(t)).join('');
    }
  }

  renderStats(columns);
}

function renderCard(t) {
  const doneCount = (t.sub_tasks || []).filter(s => s.done).length;
  const totalSubs = (t.sub_tasks || []).length;
  const pct = totalSubs > 0 ? Math.round((doneCount / totalSubs) * 100) : 0;
  const issues = t.issues || [];
  const integrations = t.integrations || [];
  const contexts = t.context_pages || [];

  let html = `<div class="task-card" data-task-id="${t.id}">`;

  // Title + difficulty
  html += `<div class="card-top">
    <div class="card-title">${esc(t.title)}</div>
    <span class="difficulty-badge diff-${t.difficulty}">${t.difficulty}</span>
  </div>`;

  // Agent
  html += `<div class="card-agent">ğŸ¤– ${esc(t.agent_id)}</div>`;

  // Description
  if (t.description) {
    html += `<div class="card-desc">${esc(t.description)}</div>`;
  }

  // Sub-tasks with progress
  if (totalSubs > 0) {
    html += `<div class="subtasks">
      <div class="subtask-progress">
        <div class="progress-bar"><div class="progress-fill" style="width:${pct}%"></div></div>
        <div class="progress-text">${doneCount}/${totalSubs}</div>
      </div>
      <ul class="subtask-list">
        ${t.sub_tasks.map(s => `<li class="subtask-item ${s.done ? 'done' : ''}">
          <span class="subtask-check">${s.done ? 'âœ“' : ''}</span>
          <span class="subtask-text">${esc(s.text)}</span>
        </li>`).join('')}
      </ul>
    </div>`;
  }

  // Integrations + context
  if (integrations.length > 0 || contexts.length > 0) {
    html += `<div class="card-tags">
      ${integrations.map(i => `<span class="tag">ğŸ”Œ ${esc(i)}</span>`).join('')}
      ${contexts.map(c => `<span class="tag" title="${esc(c.context_id)}">ğŸ“„ ${esc(c.context_name)}</span>`).join('')}
    </div>`;
  }

  // Issues
  if (issues.length > 0) {
    html += `<div class="issues-section">
      <div class="issues-title">âš ï¸ Issues (${issues.length})</div>
      ${issues.map((iss, idx) => `<div class="issue-item ${iss.resolved ? 'resolved' : ''}">
        <span style="flex:1">${esc(iss.description)}</span>
        ${iss.resolved
          ? '<span class="resolve-btn resolved">Resolved</span>'
          : `<button class="resolve-btn" onclick="resolveIssue('${t.id}', ${idx})">Resolve</button>`
        }
      </div>`).join('')}
    </div>`;
  }

  // Timestamp
  html += `<div class="card-time">
    <span>Created ${timeAgo(t.created_at)}</span>
    ${t.updated_at ? `<span>Updated ${timeAgo(t.updated_at)}</span>` : ''}
  </div>`;

  html += '</div>';
  return html;
}

function renderStats(columns) {
  const total = Object.values(columns).reduce((s, c) => s + c.length, 0);
  const agents = new Set(Object.values(tasks).map(t => t.agent_id));

  document.getElementById('statsBar').innerHTML = `
    <div class="stat-chip"><span class="stat-count">${total}</span> Total Tasks</div>
    <div class="stat-chip"><span class="stat-count" style="color:var(--accent-blue)">${columns.assigned.length}</span> Assigned</div>
    <div class="stat-chip"><span class="stat-count" style="color:var(--accent-amber)">${columns.in_progress.length}</span> In Progress</div>
    <div class="stat-chip"><span class="stat-count" style="color:var(--accent-emerald)">${columns.completed.length}</span> Completed</div>
    <div class="stat-chip"><span class="stat-count" style="color:var(--accent-rose)">${columns.error.length}</span> Blocked</div>
    <div class="stat-chip"><span class="stat-count" style="color:var(--accent-violet)">${agents.size}</span> Agents</div>
  `;
}

// â”€â”€ Actions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function resolveIssue(taskId, issueIndex) {
  try {
    const res = await fetch(`${apiUrl()}/api/tasks/${taskId}/issues/${issueIndex}/resolve`, { method: 'PATCH' });
    if (!res.ok) throw new Error(await res.text());
    const updated = await res.json();
    tasks[updated.id] = updated;
    renderBoard();
    toast('âœ… Issue resolved!');
  } catch (e) {
    toast('âŒ Failed to resolve: ' + e.message);
  }
}

// â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function esc(s) { const d = document.createElement('div'); d.textContent = s || ''; return d.innerHTML; }

function formatStatus(s) {
  return { assigned: 'ğŸ“‹ Assigned', in_progress: 'âš¡ In Progress', completed: 'âœ… Completed', error: 'ğŸš¨ Blocked' }[s] || s;
}

function emptyIcon(s) {
  return { assigned: 'ğŸ“‹', in_progress: 'âš¡', completed: 'ğŸ‰', error: 'ğŸ›¡ï¸' }[s] || 'ğŸ“¦';
}

function timeAgo(iso) {
  if (!iso) return '';
  const diff = Date.now() - new Date(iso).getTime();
  const mins = Math.floor(diff / 60000);
  if (mins < 1) return 'just now';
  if (mins < 60) return mins + 'm ago';
  const hrs = Math.floor(mins / 60);
  if (hrs < 24) return hrs + 'h ago';
  return Math.floor(hrs / 24) + 'd ago';
}

function toast(text) {
  const el = document.createElement('div');
  el.className = 'toast';
  el.textContent = text;
  document.getElementById('toasts').appendChild(el);
  setTimeout(() => el.remove(), 4000);
}

// â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
fetchTasks();
connectWs();
</script>
</body>
</html>
